let currentProduct = null;let relatedProducts = [];let productViews = 0;function getProductIdFromURL(){const urlParams = new URLSearchParams(window.location.search);return urlParams.get('id');}async function loadProductById(productId){try{console.log('Loading product with ID:', productId);const response = await fetch(`api/get_products.php`);if (!response.ok){throw new Error(`HTTP error! status: ${response.status}`);}const data = await response.json();if (data.success && data.products){const product = data.products.find(p => p.id == productId);if (product){console.log('Product found:', product);return product;}else{console.error('Product not found with ID:', productId);return null;}}else{console.error('Error loading products:', data.message);return null;}}catch (error){console.error('Error fetching product:', error);return null;}}async function loadRelatedProducts(currentProductId, categoryId, limit = 3){try{const response = await fetch('api/get_products.php');const data = await response.json();if (data.success && data.products){let related = data.products.filter(product => product.id != currentProductId && product.category_id == categoryId );if (related.length < limit){const additional = data.products.filter(product => product.id != currentProductId && !related.find(r => r.id === product.id) ).slice(0, limit - related.length);related = [...related, ...additional];}return related.slice(0, limit);}return [];}catch (error){console.error('Error loading related products:', error);return [];}}function displayProductDetail(product){console.log('Displaying product detail:', product);document.title = `${product.nama_produk}- FP Store`;document.getElementById('page-title').textContent = `${product.nama_produk}- FP Store`;document.getElementById('breadcrumb-product').textContent = product.nama_produk;const mainImage = document.getElementById('main-product-image');mainImage.src = product.foto;mainImage.alt = product.nama_produk;const categoryContainer = document.getElementById('category-badge-container');if (product.nama_kategori){categoryContainer.innerHTML = ` <span class="badge bg-primary fs-6"> <i class="${product.category_icon || 'fas fa-tag'}me-2"></i> ${product.nama_kategori}</span> `;}document.getElementById('product-title').textContent = product.nama_produk;const createdDate = new Date(product.created_at).toLocaleDateString('id-ID',{day: 'numeric', month: 'long', year: 'numeric'});document.getElementById('product-date').textContent = createdDate;productViews = Math.floor(Math.random() * 500) + 50;document.getElementById('product-views').textContent = productViews;document.getElementById('product-short-description').innerHTML = product.deskripsi_singkat || 'Tidak ada deskripsi singkat';document.getElementById('product-full-description').innerHTML = product.deskripsi || 'Tidak ada deskripsi lengkap';const whatsappBtn = document.getElementById('whatsapp-btn');const whatsappLink = createWhatsAppLink(product.nama_produk);whatsappBtn.href = whatsappLink;setupShareButton(product);document.getElementById('loading-detail').style.display = 'none';document.getElementById('product-detail-section').style.display = 'block';trackProductView(product.id);}function displayRelatedProducts(products){const container = document.getElementById('related-products');container.innerHTML = '';if (products.length === 0){container.innerHTML = ` <div class="col-12 text-center text-muted"> <p>Tidak ada produk terkait</p> </div> `;return;}products.forEach(product =>{const productCard = createRelatedProductCard(product);container.appendChild(productCard);});}function createRelatedProductCard(product){const col = document.createElement('div');col.className = 'col-lg-4 col-md-6 mb-4';const whatsappLink = createWhatsAppLink(product.nama_produk);col.innerHTML = ` <div class="card product-card h-100 shadow-sm"> <div class="position-relative"> <img src="${product.foto}" class="card-img-top product-image" alt="${product.nama_produk}" loading="lazy"> ${product.nama_kategori ? ` <div class="position-absolute top-0 start-0 m-2"> <span class="badge bg-primary"> <i class="${product.category_icon || 'fas fa-tag'}me-1"></i> ${product.nama_kategori}</span> </div> ` : ''}</div> <div class="card-body d-flex flex-column"> <h6 class="card-title fw-bold">${product.nama_produk}</h6> <p class="card-text text-muted small flex-grow-1"> ${product.deskripsi_singkat ? product.deskripsi_singkat.substring(0, 80) + '...' : 'Tidak ada deskripsi'}</p> <div class="mt-auto"> <div class="row g-2"> <div class="col-8"> <a href="${whatsappLink}" target="_blank" class="btn btn-success btn-sm w-100"> <i class="fab fa-whatsapp me-1"></i>Pesan </a> </div> <div class="col-4"> <a href="detail-produk.php?id=${product.id}" class="btn btn-outline-primary btn-sm w-100"> <i class="fas fa-eye"></i> </a> </div> </div> </div> </div> </div> `;return col;}function setupShareButton(product){const shareBtn = document.getElementById('share-btn');shareBtn.addEventListener('click', function(){const productUrl = window.location.href;const shareText = `Check out this product: ${product.nama_produk}`;if (navigator.share){navigator.share({title: product.nama_produk, text: shareText, url: productUrl}).catch(console.error);}else{navigator.clipboard.writeText(productUrl).then(() =>{showNotification('Link produk berhasil disalin!', 'success');}).catch(() =>{showShareModal(product, productUrl);});}});}function trackProductView(productId){try{const views = JSON.parse(localStorage.getItem('fp_store_product_views') || '{}');views[productId] = (views[productId] || 0) + 1;localStorage.setItem('fp_store_product_views', JSON.stringify(views));trackRecentlyViewed(currentProduct);}catch (error){console.error('Error tracking view:', error);}}function trackRecentlyViewed(product){try{const recentlyViewed = JSON.parse(localStorage.getItem('fp_store_recently_viewed') || '[]');const filtered = recentlyViewed.filter(item => item.id !== product.id);filtered.unshift({id: product.id, nama_produk: product.nama_produk, foto: product.foto, deskripsi_singkat: product.deskripsi_singkat, viewed_at: new Date().toISOString()});const limited = filtered.slice(0, 10);localStorage.setItem('fp_store_recently_viewed', JSON.stringify(limited));}catch (error){console.error('Error tracking recently viewed:', error);}}function showShareModal(product, url){const modal = document.createElement('div');modal.className = 'modal fade';modal.innerHTML = ` <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Bagikan Produk</h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p>Bagikan produk "${product.nama_produk}" melalui:</p> <div class="d-grid gap-2"> <a href="https: target="_blank" class="btn btn-success"> <i class="fab fa-whatsapp me-2"></i>WhatsApp </a> <a href="https: target="_blank" class="btn btn-primary"> <i class="fab fa-facebook me-2"></i>Facebook </a> <a href="https: target="_blank" class="btn btn-info"> <i class="fab fa-twitter me-2"></i>Twitter </a> </div> </div> </div> </div> `;document.body.appendChild(modal);const bsModal = new bootstrap.Modal(modal);bsModal.show();modal.addEventListener('hidden.bs.modal', () =>{document.body.removeChild(modal);});}function showErrorState(){document.getElementById('loading-detail').style.display = 'none';document.getElementById('error-state').style.display = 'block';}async function initializeProductDetail(){console.log('Initializing product detail page...');const productId = getProductIdFromURL();if (!productId){console.error('No product ID provided');showErrorState();return;}try{await loadSettings();const product = await loadProductById(productId);if (!product){showErrorState();return;}currentProduct = product;displayProductDetail(product);if (product.category_id){const related = await loadRelatedProducts(product.id, product.category_id);relatedProducts = related;displayRelatedProducts(related);}}catch (error){console.error('Error initializing product detail:', error);showErrorState();}}document.addEventListener('DOMContentLoaded', function(){console.log('DOM loaded, initializing product detail...');initializeProductDetail();});window.initializeProductDetail = initializeProductDetail;window.getProductIdFromURL = getProductIdFromURL;